# Введение

В последнее время Telegram становится все популярнее, так как помимо функций мессенджера содержит в себе функции социальной сети. В случае проекта важно именно второе, потому что как соцсеть Telegram имеет несколько особенностей. Одна из них — строгое разделение лент каналов. Этот подход имеет свои плюсы, но у него есть два существенных недостатка: во-первых, нет удобной возможности просматривать посты в хронологическом порядке, во-вторых, если два канала опубликовали схожие посты, пользователь посмотрит и тот, и тот, что является тратой времени.

В случае новостей эти недостатки становятся критическими. По очевидным причинам, среди новостных постов очень много “дубликатов” — постов, сообщающих об одном и том же, но разными словами. Во-вторых, в случае новостей возможность просмотреть посты в хронологическом порядке важна больше, чем где-либо ещё.

Цель работы заключается в разработке телеграм-бота, собирающего посты из разных каналов в одну “ленту”, заменяя папку “новости” одним чатом.

## Целевая аудитория

Целевой аудиторией бота являются люди:

1. Использующие Telegram
2. Читающие там новости
3. Умеющие пользоваться Telegram-ботами

## Анализ предметной области

Взаимодействие с Телеграмом в стандартном случае выглядит так: на домашнем экране приложения пользователю показывается список каналов и чатов, отсортированный по времени отправки последнего сообщения: чем позже было отправлено последннее сообщение в чате/канале, тем он выше он в списке.
![[/rdm/Pasted_image_20230611182837.png]]
Рис.1 Пример интерфейса Telegram

Если пользователь заходит в канал, ему показывается лента всех постов, отсортированная в хронологическом порядке сверху вниз. В случае, если все непрочитанные посты не могут поместиться на экране пользователя, Telegram начинает показывать ленту с самого раннего непрочитанного поста.
![[/rdm/Pasted_image_20230611183830.png]]
Рис.2 Пример интерфейса каналов Teleram

Когда пользователь прочитывает все посты одного канала, он может потянуть ленту вниз и его перекинет в следующий канал.

## Аналоги

Прямой аналог созданного бота, как ни странно, всего один — **Channels**, и имеет существенный недостаток — без подписки в нём доступно получение постов всего из 7 каналов, что откровенно мало.  Также условными аналогами нашего бота можно считать ленты рекомендаций различных социальных сетей, но они, опять же, имеют свои особенности, начиная с рекламы и заканчивая невозможностью отключения системы рекомендаций.

|                                              | Channels | News Next | Reddit | ВКонтакте |
| -------------------------------------------- | -------- | --------- | ------ | --------- |
| Бесплатно                                    | -        | +         | +      | +         |
| Фильтрация одинаковых постов                 | -        | +         | ~      | ~         |
| Нет рекламы                                  | +        | +         | ~      | -         |
| Интерфейс на русском языке                   | -        | +         | +      | +         |
| Возможность сбора данных из закрытых каналов | +        | -         | ∅      | ∅         |

## Постановка задачи

Должны быть решены следующие задачи:

1. Создание парсера, способного постоянно получать новые посты из выбранных телеграм-каналов
2.  
3. Создание базы данных, способной хранить необходимые для работы бота и системы анализа сообщений данные
4. Создание бота, способного
   - сохранять каналы, на которые подписан пользователь,
   - присылать собранные парсером сообщения, предлагая ссылку оригинальный пост
   - редактировать старые сообщения, добавляя в них ссылки на схожие посты, полученные позже
   - обрезать слишком длинные посты для экономии внимания пользователя
   - включать/выключать для отдельных пользователей работу двух последних пунктов
   - менять язык для отдельных пользователей

## Решение

### Алгоритмы

Одним из элементов проекта является модуль, отбраковывающий новости об одном и том же. Его можно разделить на два субмодуля: подготавливающий тексты и анализирующий их.

Алгоритм работы модуля, подготавливающего тексты, состоит их следующих действий:

1. Очистка полученного текста от запятых
2. Разбивка его на список отдельных слов
3. Приведение этих слов в начальную форму (лемматизация)
4. Удаление из этого списка мусорных слов — слов, которые часто встречаются в тексте, но не несут особой смысловой нагрузки.
5. Сохранение этого списка

Алгоритм работы модуля, сравнивающиего тексты, состоит их следующих действий:

1. Получение массивов слов двух постов
2. Создание списка из всех уникальных слов в обоих массивах
3. Создание для каждого из постов массив нулей, каждый из которых как бы соответствует одному из слов в первом списке
4. Прохождение по словам каждого из постов, добавляя по единице в соответсвующую ячейку массива
5. Рассчёт косинус между этими массивами, как если бы они были просто векторами с большим количеством измерений

### Технологии

#### Интерфейсы взаимодействия с Телеграмом

Для взаимодействия сторонних программ с сервисами Телеграма его разработчики создали несколько API (Application Programming Interface):

1. **Telegram Bot API** — заточен конкретно под написание ботов. У него сравнительно скудный список возможностей: нельзя, в том числе, брать сообщения из каналов/чатов, в которых не состоит бот, что необходимо для нашего проекта. С другой стороны, он очень популярный, из-за чего для работы с ним есть много библиотек и по нему написано много гайдов.

2. **TDLib** — создан для написания полноценных клиентов(приложений) Телеграма. Соответственно, через него можно делать всё, что может стандартное приложение. Не так популярен, из-за чего выбор библиотек не так велик, и гайды по большей части заканчиваются документацией. Для доступа к нему необходимо зарегистрироваться в качестве разработчика Телеграм-приложений, после чего разработчику выдаётся персональный ключ для доступа к API.

#### База данных

База данных состоит из следующих таблиц:

- **channels** — каналы

 1. *id* — ключ таблицы, автоинкремент
 2. *name* — юзернейм канала
 3. *last_message* — id последнего сообщения канала

- **users** — настройки пользователей

 1. *chat* — ключ таблицы, telegram chat_id
 2. *lang* — выбранный язык интерфейса. Имеет вид типа en
 3. *shorten_msgs* — сокращение сообщений. 0 — выключено, 1 — включено
 4. *del_sim* — удаление одинаковых сообщений. 0 — выключено, 1 — включено

- **posts** — посты каналов

 1. *id* — ключ таблицы, автоинкремент
 2. *channel* — ссылка на id из таблицы channels
 3. *lem_text* — подготовленный к анализу текст

- **subs** — подписки пользователей на каналы

 1. *user* — ссылка на id из таблицы users
 2. *channel* — ссылка на id из таблицы channels

- **user_posts** — посты, находящиеся в чате у каждого пользователя

 1. *user* — ссылка на id из таблицы users
 2. *id* — id сообщения в чате
 3. *text* — текст сообщения в чате
 4. *post* — ссылка на id из таблицы posts
![[/rdm/Pasted_image_20230613125311.png]]
Рис.3 Архитектура базы данных

### Программная реализация

#### Языки, СУБД

**Python** — для написания бота, модуля анализа текстов, парсера и взаимодействия с базой данных
**Sqlite** — для работы с базами данных. Был выбран, т.к модуль для работы с ним встроен в python

#### Среды

**Visual Studio Code** — написание кода
**DataGrip** — работа с базой данных

#### Библиотеки

1. **Telethon** — для работы с TDLib
2. **Python-telegram-bot** — для работы с Telegram Bot API
3. **Pymystem3** — для работы с созданным Яндексом MyStem — инструментом, который, среди прочего, имеет в своём функционале лемматизацию (приведение к начальной форме) слов на русском языке.  
4. **NLTK (Natural Language Toolkit)** — для анализа текстов, из этой библиотеки был взят список “мусорных слов” — слов, которые часто встречаются в тексте, но не несут особой смысловой нагрузки.

## Ход работы

В начале разработки я и экс-тиммейт решили разделить задачи следующим образом: я занимаюсь анализом текста, он пишет бота. На тот момент планировалось создание ещё и системы рекомендаций, и поэтому я занимался исключительно проектированием и изучением статей и наработок по теме. Стоит отметить, что по различным причинам ничего из этого периода разработки в проект не пошло.

Разработка буксовала, и после совещания с руководителем было принято решение сначала коллективно сделать бота и парсер, потом приниматься за анализ сообщений.
Первым этапом было создание модуля, способного получать тексты сообщений из каналов.  Также немало времени ушло на провалившуюся попытку создать часть, способную пересылать медиа из каналов. Оказалось, что это, судя по всему, невозможно: если пытаться кэшировать каждый элемент медиа, API даже во время тестирования отправляет парсер во временный бан за черезчур активное использование ресурсов, а пересылать медиа по id невозможно, так как, вероятнее всего, этот id уникален для каждого пользователя.

Судя по всему, из-за того, что для тестирования парсер собирал одни и те же сообщения из одного и того же канала, сервера Телеграма заподозрили меня в ботоводстве и забанили мой ключ к API. Из-за этого пришлось на время отложить разработку парсера и перейти к другим элементам проекта.

Стоит отметить, что перед тем, как начать разработку анализатора текстов, была предпринята попытка немного сменить тему на написание кастомного клиента Телеграма с добавлением того же функционала, что планировался в боте. Идея не столь безумная, как кажется на первый взгляд, так как исходный код клиентов Телеграма есть в открытом доступе. Но, провозившись с исходниками Telegram и Telegram-X две недели и не сумев даже их запустить, я принял решение вернуться к написанию бота.

Так как из-за бана ключа для API сама концепция бота была несколько туманна, было принято решение начать делать модуль сравнения текстов.

Первым этапом создания этого модуля стал сбор набора новостных текстов. Для этого был написан своеобразный парсер, представлявший собой бота, которому надо было вручную пересылать новости.

Изначально определять схожие посты планировалось путём сравнения результатов их векторизации с помощью BERT, но из-за тажеловесности этого метода было решено делать это с помощью частотного анализа.

Параллельно с этим была решена проблема с ключом для API, создана база данных и всё это было собрано в конечный продукт. Было начато тестирование на аудитории.

В дальшейшем исправлялись баги и добавлялись по большей части минорные улучшения: добавлены пользовательские настройки, сокращение постов, решена проблема невозможности пересылки медиа: они показываются в превью ссылки на оригинальный пост, и т.д.

## Результаты

### Что удалось достичь

- Создан алгоритм сбора данных из открытых каналов
- Написан алгоритм отбора новостей об одном и том же
- Спроектирована и написана база данных
- Написан бот с полноценным интерфейсом

### Что не удалось достичь

- Сбор данных из закрытых каналов
- Система рекомендаций. Впрочем, есть подозрение, что сервису-аггрегатору новостей она если не вредна, то, по меньшей мере, не очень нужна

### Где используется

- Бот находится в открытом доступе уже неделю, пока что основной генерируемый фидбек — сообщания об ошибках.

### Дополнительные сезультаты

- В процессе создания модуля частотного анализа был написан скрипт, способный собирать большое

## Выводы

В ходе работы были созданы

## Направление дальнейшей разработки

- Создание системы рекомендаций
- Перевод бота на webhook'и
- Добавление модуля, сокращающего посты с помощью нейросети
- Дальнейшее улучшение интерфейса

## Пример использования

Для начала работы с ботом пользователь должен написать ему команду /start. В ответ на неё бот отправит ему приветственное сообщение
![[/rdm/Pasted_image_20230613224018.png]]
Рис.4 Пример работы проекта

В дальнейшем все команды можно будет выбирать и отправлять с помощью кнопки menu
![[/rdm/Pasted_image_20230613224209.png]]
Рис.5 Пример работы проекта

Пользователь может получить список доступных команд, прописав /help
![[/rdm/Pasted_image_20230613224304.png]]
Рис.6 Пример работы проекта

Чтобы подписаться на канал, пользователю необходимо прописать команду /subscribe и ввести ссылку или юзернейм необходимого канала
![[/rdm/Pasted_image_20230613224546.png]]
Рис.7 Пример работы проекта

Если пользователь хочет посмотреть список каналов, на которые он подписан, он может прописать команду /my_channels
![[/rdm/Pasted_image_20230613230659.png]]
Рис.8 Пример работы проекта

Чтобы отписаться на канал, пользователю необходимо прописать команду /unsubscribe и ввести ссылку или юзернейм необходимого канала
![[/rdm/Pasted_image_20230614124932.png]]
Рис.9 Пример работы проекта

В дальнейшем каждое новое появившееся в канале сообщение будет присылаться в этот чат в следующем виде:
![[/rdm/Untitled.png]]
Рис.10 Пример работы проекта

В случае, если похожий пост появится в другом канале, бот отредактирует это сообщение, вставив в него ссылку на новый пост
![[/rdm/Pasted_image_20230613230248.png]]
Рис.11 Пример работы проекта

В случае, если оригинальный пост длиннее двух тысяч символов, он сокращается до начала:
![[/rdm/Pasted_image_20230613234243.png]]
Рис.12 Пример работы проекта

В случае, если пользователь хочет настроить какие-либо элементы бота, он может прописать команду /settings и настроить то, что ему необходимо: изменить языки интерфейса, включить/выключить фильтрацию похожих новостей, включить/выключить сокращение постов
![[/rdm/Pasted_image_20230613234437.png]]
Рис.13 Пример работы проекта
![[/rdm/Pasted_image_20230613234449.png]]
Рис.14 Пример работы проекта
![[/rdm/Pasted_image_20230613234507.png]]
Рис.15 Пример работы проекта

![[/rdm/Pasted_image_20230613234539.png]]
Рис.16 Пример работы проекта
![[/rdm/Pasted_image_20230613234604.png]]
Рис.17 Пример работы проекта
![[/rdm/Pasted_image_20230614015618.png]]
Рис.4 Пример работы проекта

## Литература + источники

<https://docs.telethon.dev/en/stable/>
<https://docs.python-telegram-bot.org/en/stable/>
<https://docs.python.org/3/library/sqlite3.html>
<https://www.nltk.org/howto/corpus.html>
<https://numpy.org/doc/stable/reference/routines.linalg.html>
<https://docs.python.org/3/library/asyncio-task.html>
<https://docs.python.org/3/library/asyncio-task.html>
<https://carpedm20.github.io/emoji/docs/index.html#id2>
<https://www.geeksforgeeks.org/python-lemmatization-with-nltk/>
<https://melaniewalsh.github.io/Intro-Cultural-Analytics/05-Text-Analysis/Multilingual/Russian/01-Preprocessing-Russian.html>
<https://www.kaggle.com/code/alxmamaev/how-to-easy-preprocess-russian-text>
<https://docs.python.org/3/library/string.html>
<https://pypi.org/project/pymystem3/>

## Приложения

![[/rdm/NNB_Component_Diagram.jpg]]
Рис.17 Архитектура компонентов
